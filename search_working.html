<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©è®°å½•æœç´¢ - å®æ—¶è¿›åº¦ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .filter-select, .btn {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-select:focus {
            border-color: #4facfe;
        }

        .btn {
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .progress-section {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6c757d;
        }

        .results-section {
            padding: 30px;
            min-height: 400px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .results-stats {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }

        .results-grid {
            display: grid;
            gap: 20px;
        }

        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #4facfe;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-sender {
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-time {
            font-size: 12px;
            color: #6c757d;
        }

        .result-content {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .result-file {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .media-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .media-type.text {
            background: #d4edda;
            color: #155724;
        }

        .media-type.image {
            background: #cce5ff;
            color: #004085;
        }

        .media-type.emoji {
            background: #fff3cd;
            color: #856404;
        }

        .media-type.video {
            background: #f8d7da;
            color: #721c24;
        }

        .media-type.audio {
            background: #e2e3e5;
            color: #383d41;
        }

        .media-type.sticker {
            background: #d1ecf1;
            color: #0c5460;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-results i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-results h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .search-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” èŠå¤©è®°å½•æœç´¢</h1>
            <p>å®æ—¶æœç´¢æ‰€æœ‰èŠå¤©è®°å½•ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æƒ…ç­‰å¤šç§å†…å®¹</p>
        </div>

        <div class="search-section">
            <div class="search-controls">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯...">
                </div>
                <select id="senderFilter" class="filter-select">
                    <option value="">æ‰€æœ‰å‘é€è€…</option>
                    <option value="ç”Ÿç”Ÿ">ç”Ÿç”Ÿ</option>
                    <option value="æ˜Ÿå¦‚é›¨">æ˜Ÿå¦‚é›¨</option>
                </select>
                <select id="mediaFilter" class="filter-select">
                    <option value="">æ‰€æœ‰ç±»å‹</option>
                    <option value="text">æ–‡æœ¬</option>
                    <option value="image">å›¾ç‰‡</option>
                    <option value="emoji">è¡¨æƒ…</option>
                    <option value="video">è§†é¢‘</option>
                    <option value="audio">éŸ³é¢‘</option>
                    <option value="sticker">è´´çº¸</option>
                </select>
                <button id="searchBtn" class="btn btn-primary">æœç´¢</button>
                <button id="cancelBtn" class="btn btn-secondary" style="display: none;">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="progressSection" class="progress-section">
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div class="progress-info">
                <span id="progressText">æ­£åœ¨æœç´¢ä¸­...</span>
                <span id="progressStats">0 / 0</span>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-stats">
                    <span id="resultsCount">å…±æ‰¾åˆ° 0 æ¡ç»“æœ</span>
                </div>
            </div>
            <div id="resultsContainer" class="results-grid">
                <div class="no-results">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">ğŸ”</div>
                    <h3>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</h3>
                    <p>æ”¯æŒæœç´¢æ–‡æœ¬å†…å®¹ã€å›¾ç‰‡æè¿°ã€è¡¨æƒ…ç¬¦å·ç­‰</p>
                </div>
            </div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allFiles = [];
        let searchResults = [];
        let currentPage = 1;
        const resultsPerPage = 20;
        let searchController = null;
        let isSearching = false;

        // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
        function initializeFileList() {
            // å®Œæ•´çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆä»2022å¹´åˆ°2025å¹´ï¼‰
            allFiles = [
                { url: 'Data/chat_2022_09_24.html', date: '2022-09-24' },
                { url: 'Data/chat_2022_10_01.html', date: '2022-10-01' },
                { url: 'Data/chat_2022_10_02.html', date: '2022-10-02' },
                { url: 'Data/chat_2022_10_05.html', date: '2022-10-05' },
                { url: 'Data/chat_2022_10_06.html', date: '2022-10-06' },
                { url: 'Data/chat_2022_10_07.html', date: '2022-10-07' },
                { url: 'Data/chat_2022_10_09.html', date: '2022-10-09' },
                { url: 'Data/chat_2022_10_10.html', date: '2022-10-10' },
                { url: 'Data/chat_2022_10_11.html', date: '2022-10-11' },
                { url: 'Data/chat_2022_10_14.html', date: '2022-10-14' },
                { url: 'Data/chat_2022_10_15.html', date: '2022-10-15' },
                { url: 'Data/chat_2022_10_16.html', date: '2022-10-16' },
                { url: 'Data/chat_2022_10_20.html', date: '2022-10-20' },
                { url: 'Data/chat_2022_10_21.html', date: '2022-10-21' },
                { url: 'Data/chat_2022_10_22.html', date: '2022-10-22' },
                { url: 'Data/chat_2022_10_23.html', date: '2022-10-23' },
                { url: 'Data/chat_2022_10_26.html', date: '2022-10-26' },
                { url: 'Data/chat_2022_10_28.html', date: '2022-10-28' },
                { url: 'Data/chat_2022_10_29.html', date: '2022-10-29' },
                { url: 'Data/chat_2022_10_30.html', date: '2022-10-30' },
                { url: 'Data/chat_2022_10_31.html', date: '2022-10-31' },
                { url: 'Data/chat_2022_11_01.html', date: '2022-11-01' },
                { url: 'Data/chat_2022_11_02.html', date: '2022-11-02' },
                { url: 'Data/chat_2022_11_03.html', date: '2022-11-03' },
                { url: 'Data/chat_2022_11_04.html', date: '2022-11-04' },
                { url: 'Data/chat_2022_11_05.html', date: '2022-11-05' },
                { url: 'Data/chat_2022_11_06.html', date: '2022-11-06' },
                { url: 'Data/chat_2022_11_07.html', date: '2022-11-07' },
                { url: 'Data/chat_2022_11_09.html', date: '2022-11-09' },
                { url: 'Data/chat_2022_11_10.html', date: '2022-11-10' },
                { url: 'Data/chat_2022_11_11.html', date: '2022-11-11' },
                { url: 'Data/chat_2022_11_12.html', date: '2022-11-12' },
                { url: 'Data/chat_2022_11_13.html', date: '2022-11-13' },
                { url: 'Data/chat_2022_11_14.html', date: '2022-11-14' },
                { url: 'Data/chat_2022_11_15.html', date: '2022-11-15' },
                { url: 'Data/chat_2022_11_16.html', date: '2022-11-16' },
                { url: 'Data/chat_2022_11_17.html', date: '2022-11-17' },
                { url: 'Data/chat_2022_11_18.html', date: '2022-11-18' },
                { url: 'Data/chat_2022_11_19.html', date: '2022-11-19' },
                { url: 'Data/chat_2022_11_20.html', date: '2022-11-20' },
                { url: 'Data/chat_2022_11_21.html', date: '2022-11-21' },
                { url: 'Data/chat_2022_11_22.html', date: '2022-11-22' },
                { url: 'Data/chat_2022_11_23.html', date: '2022-11-23' },
                { url: 'Data/chat_2022_11_24.html', date: '2022-11-24' },
                { url: 'Data/chat_2022_11_25.html', date: '2022-11-25' },
                { url: 'Data/chat_2022_11_26.html', date: '2022-11-26' },
                { url: 'Data/chat_2022_11_27.html', date: '2022-11-27' },
                { url: 'Data/chat_2022_11_28.html', date: '2022-11-28' },
                { url: 'Data/chat_2022_11_29.html', date: '2022-11-29' },
                { url: 'Data/chat_2022_11_30.html', date: '2022-11-30' },
                { url: 'Data/chat_2022_12_02.html', date: '2022-12-02' },
                { url: 'Data/chat_2022_12_03.html', date: '2022-12-03' },
                { url: 'Data/chat_2022_12_10.html', date: '2022-12-10' },
                { url: 'Data/chat_2022_12_12.html', date: '2022-12-12' },
                { url: 'Data/chat_2022_12_20.html', date: '2022-12-20' },
                { url: 'Data/chat_2022_12_28.html', date: '2022-12-28' },
                { url: 'Data/chat_2022_12_29.html', date: '2022-12-29' },
                { url: 'Data/chat_2022_12_30.html', date: '2022-12-30' },
                { url: 'Data/chat_2022_12_31.html', date: '2022-12-31' },
                { url: 'Data/chat_2023_01_01.html', date: '2023-01-01' },
                { url: 'Data/chat_2023_01_02.html', date: '2023-01-02' },
                { url: 'Data/chat_2023_01_03.html', date: '2023-01-03' },
                { url: 'Data/chat_2023_01_04.html', date: '2023-01-04' },
                { url: 'Data/chat_2023_01_05.html', date: '2023-01-05' },
                { url: 'Data/chat_2023_01_06.html', date: '2023-01-06' },
                { url: 'Data/chat_2023_01_07.html', date: '2023-01-07' },
                { url: 'Data/chat_2023_01_08.html', date: '2023-01-08' },
                { url: 'Data/chat_2023_01_09.html', date: '2023-01-09' },
                { url: 'Data/chat_2023_01_10.html', date: '2023-01-10' },
                { url: 'Data/chat_2023_01_11.html', date: '2023-01-11' },
                { url: 'Data/chat_2023_01_12.html', date: '2023-01-12' },
                { url: 'Data/chat_2023_01_13.html', date: '2023-01-13' },
                { url: 'Data/chat_2023_01_14.html', date: '2023-01-14' },
                { url: 'Data/chat_2025_09_28.html', date: '2025-09-28' }
            ];
        }

        // è§£æå•ä¸ªèŠå¤©æ–‡ä»¶
        async function parseChatFile(fileUrl) {
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    console.warn(`æ— æ³•åŠ è½½æ–‡ä»¶: ${fileUrl}`);
                    return [];
                }
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const messages = [];
                
                // æŸ¥æ‰¾æ‰€æœ‰æ¶ˆæ¯å®¹å™¨
                const messageElements = doc.querySelectorAll('.message');
                
                messageElements.forEach((message, index) => {
                    try {
                        // è·å–å‘é€è€…ä¿¡æ¯
                        const senderElement = message.querySelector('.message-header .sender');
                        const sender = senderElement ? senderElement.textContent.trim() : 'æœªçŸ¥';
                        
                        // è·å–æ—¶é—´ä¿¡æ¯
                        const timeElement = message.querySelector('.message-header .time');
                        const time = timeElement ? timeElement.textContent.trim() : '';
                        
                        // è·å–æ¶ˆæ¯å†…å®¹
                        const contentElement = message.querySelector('.message-content');
                        let content = '';
                        let mediaType = 'text';
                        
                        if (contentElement) {
                            // è·å–æ‰€æœ‰æ–‡æœ¬å†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡altæ–‡æœ¬
                            const textParts = [];
                            contentElement.querySelectorAll('*').forEach(el => {
                                if (el.nodeType === Node.TEXT_NODE) {
                                    textParts.push(el.textContent);
                                } else if (el.tagName === 'IMG') {
                                    // å›¾ç‰‡æ–‡ä»¶ï¼Œè®°å½•altæ–‡æœ¬å’Œsrc
                                    const alt = el.getAttribute('alt') || '';
                                    const src = el.getAttribute('src') || '';
                                    if (alt) textParts.push(alt);
                                    mediaType = 'image';
                                } else if (el.tagName === 'VIDEO') {
                                    mediaType = 'video';
                                } else if (el.tagName === 'AUDIO') {
                                    mediaType = 'audio';
                                } else if (el.classList && el.classList.contains('sticker')) {
                                    mediaType = 'sticker';
                                } else {
                                    // å…¶ä»–å…ƒç´ ï¼Œè·å–å…¶æ–‡æœ¬å†…å®¹
                                    textParts.push(el.textContent);
                                }
                            });
                            
                            content = textParts.join(' ').trim();
                            
                            // å¦‚æœå†…å®¹ä¸ºç©ºä½†æœ‰åª’ä½“å…ƒç´ ï¼Œä½¿ç”¨åª’ä½“ç±»å‹ä½œä¸ºå†…å®¹
                            if (!content && mediaType !== 'text') {
                                content = `[${mediaType}]`;
                            }
                        }
                        
                        // åªæœ‰å†…å®¹ä¸ä¸ºç©ºæ‰æ·»åŠ åˆ°ç»“æœä¸­
                        if (content && content.length > 0) {
                            messages.push({
                                sender: sender,
                                time: time,
                                content: content,
                                mediaType: mediaType,
                                fileUrl: fileUrl,
                                messageId: `${fileUrl}_${index}`
                            });
                        }
                    } catch (messageError) {
                        console.warn(`è§£ææ¶ˆæ¯æ—¶å‡ºé”™: ${messageError.message}`);
                    }
                });
                
                return messages;
            } catch (error) {
                console.error(`è§£ææ–‡ä»¶ ${fileUrl} æ—¶å‡ºé”™:`, error);
                return [];
            }
        }

        // æ‰§è¡Œæœç´¢ï¼ˆå¸¦å®æ—¶è¿›åº¦ï¼‰
        async function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const senderFilter = document.getElementById('senderFilter').value;
            const mediaFilter = document.getElementById('mediaFilter').value;
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            // åˆ›å»ºæ–°çš„AbortController
            searchController = new AbortController();
            isSearching = true;
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('searchBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultsContainer').innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æœç´¢ä¸­...</div>';
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            searchResults = [];
            currentPage = 1;
            
            // è¿‡æ»¤æ–‡ä»¶
            const filteredFiles = allFiles.filter(file => {
                if (senderFilter && mediaFilter) {
                    return true; // å¦‚æœä¸¤ä¸ªéƒ½æœ‰å€¼ï¼Œä¸è¿‡æ»¤æ–‡ä»¶
                }
                return true;
            });
            
            let processedFiles = 0;
            let totalFiles = filteredFiles.length;
            let foundResults = 0;
            
            // é€ä¸ªæ–‡ä»¶æœç´¢ï¼Œå®æ—¶æ›´æ–°ç»“æœ
            for (let i = 0; i < filteredFiles.length; i++) {
                if (searchController.signal.aborted) {
                    break;
                }
                
                const file = filteredFiles[i];
                
                try {
                    const messages = await parseChatFile(file.url);
                    
                    // åœ¨å½“å‰æ–‡ä»¶ä¸­æœç´¢
                    const fileResults = messages.filter(message => {
                        // æ£€æŸ¥æœç´¢è¯
                        const contentMatch = message.content.toLowerCase().includes(searchTerm.toLowerCase());
                        
                        // æ£€æŸ¥å‘é€è€…è¿‡æ»¤
                        const senderMatch = !senderFilter || message.sender === senderFilter;
                        
                        // æ£€æŸ¥åª’ä½“ç±»å‹è¿‡æ»¤
                        const mediaMatch = !mediaFilter || message.mediaType === mediaFilter;
                        
                        return contentMatch && senderMatch && mediaMatch;
                    });
                    
                    // æ·»åŠ æ–‡ä»¶ä¿¡æ¯åˆ°ç»“æœ
                    fileResults.forEach(result => {
                        result.fileName = file.url;
                        result.fileDate = file.date;
                    });
                    
                    // å®æ—¶æ·»åŠ åˆ°ç»“æœä¸­
                    searchResults.push(...fileResults);
                    foundResults += fileResults.length;
                    
                    // æ›´æ–°è¿›åº¦
                    processedFiles++;
                    const progress = (processedFiles / totalFiles) * 100;
                    
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `æ­£åœ¨æœç´¢: ${file.url}`;
                    document.getElementById('progressStats').textContent = `${processedFiles} / ${totalFiles} (æ‰¾åˆ° ${foundResults} æ¡)`;
                    
                    // å®æ—¶æ›´æ–°ç»“æœæ˜¾ç¤º
                    if (fileResults.length > 0) {
                        updateResultsDisplay();
                    }
                    
                } catch (error) {
                    console.error(`æœç´¢æ–‡ä»¶ ${file.url} æ—¶å‡ºé”™:`, error);
                }
                
                // ç»™UIä¸€ä¸ªæ›´æ–°çš„æœºä¼š
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // æœç´¢å®Œæˆ
            isSearching = false;
            document.getElementById('searchBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = 'æœç´¢å®Œæˆï¼';
            
            // æœ€ç»ˆæ›´æ–°ç»“æœ
            updateResultsDisplay();
            
            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(() => {
                document.getElementById('progressSection').classList.remove('active');
            }, 3000);
        }

        // å–æ¶ˆæœç´¢
        function cancelSearch() {
            if (searchController) {
                searchController.abort();
                isSearching = false;
                document.getElementById('searchBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('progressSection').classList.remove('active');
                document.getElementById('progressText').textContent = 'æœç´¢å·²å–æ¶ˆ';
            }
        }

        // æ›´æ–°ç»“æœæ˜¾ç¤º
        function updateResultsDisplay() {
            const container = document.getElementById('resultsContainer');
            const countElement = document.getElementById('resultsCount');
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            countElement.textContent = `å…±æ‰¾åˆ° ${searchResults.length} æ¡ç»“æœ`;
            
            if (searchResults.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">ğŸ˜”</div>
                        <h3>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</h3>
                        <p>å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const totalPages = Math.ceil(searchResults.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = Math.min(startIndex + resultsPerPage, searchResults.length);
            const pageResults = searchResults.slice(startIndex, endIndex);
            
            // ç”Ÿæˆç»“æœHTML
            let resultsHTML = '';
            pageResults.forEach(result => {
                const highlightedContent = highlightSearchTerm(result.content, searchTerm);
                resultsHTML += `
                    <div class="result-item" onclick="openMessage('${result.fileUrl}', '${result.messageId}')">
                        <div class="result-header">
                            <div class="result-sender">
                                ${result.sender}
                                <span class="media-type ${result.mediaType}">${getMediaTypeName(result.mediaType)}</span>
                            </div>
                            <div class="result-time">${result.time}</div>
                        </div>
                        <div class="result-content">${highlightedContent}</div>
                        <div class="result-file">ğŸ“ ${result.fileName} | ğŸ“… ${result.fileDate}</div>
                    </div>
                `;
            });
            
            container.innerHTML = resultsHTML;
            
            // æ›´æ–°åˆ†é¡µ
            updatePagination(totalPages);
        }

        // é«˜äº®æœç´¢è¯
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // è·å–åª’ä½“ç±»å‹åç§°
        function getMediaTypeName(mediaType) {
            const typeNames = {
                'text': 'æ–‡æœ¬',
                'image': 'å›¾ç‰‡',
                'emoji': 'è¡¨æƒ…',
                'video': 'è§†é¢‘',
                'audio': 'éŸ³é¢‘',
                'sticker': 'è´´çº¸'
            };
            return typeNames[mediaType] || 'æœªçŸ¥';
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                    ä¸Šä¸€é¡µ
                </button>
            `;
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                    ä¸‹ä¸€é¡µ
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            currentPage = page;
            updateResultsDisplay();
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
        }

        // æ‰“å¼€æ¶ˆæ¯ï¼ˆè·³è½¬åˆ°å¯¹åº”ä½ç½®ï¼‰
        function openMessage(fileUrl, messageId) {
            // æ„å»ºå®Œæ•´çš„URL
            const fullUrl = fileUrl + '#' + messageId;
            window.open(fullUrl, '_blank');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢æŒ‰é’®
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelBtn').addEventListener('click', cancelSearch);
            
            // å›è½¦æœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isSearching) {
                    performSearch();
                }
            });
            
            // ç­›é€‰æ¡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨æœç´¢
            document.getElementById('senderFilter').addEventListener('change', function() {
                if (document.getElementById('searchInput').value.trim() && !isSearching) {
                    performSearch();
                }
            });
            
            document.getElementById('mediaFilter').addEventListener('change', function() {
                if (document.getElementById('searchInput').value.trim() && !isSearching) {
                    performSearch();
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileList();
            setupEventListeners();
        });
    </script>
</body>
</html>