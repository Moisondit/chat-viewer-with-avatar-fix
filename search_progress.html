<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©è®°å½•æœç´¢ - å®æ—¶è¿›åº¦ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-form {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-input-group {
            display: flex;
            gap: 15px;
            align-items: stretch;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cancel-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .progress-section {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: #495057;
        }

        .progress-stats {
            font-size: 14px;
            color: #6c757d;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .current-file {
            font-size: 13px;
            color: #6c757d;
            margin-top: 5px;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .stats-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 600;
            color: #495057;
            font-size: 16px;
        }

        .results-section {
            padding: 30px;
            min-height: 300px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #495057;
        }

        .results-count {
            background: #4facfe;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .result-date {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .result-sender {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .result-content {
            color: #212529;
            line-height: 1.5;
        }

        .highlight {
            background: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            color: #6c757d;
            font-size: 18px;
            padding: 60px 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 15px;
            border: 1px solid #e9ecef;
            background: white;
            color: #495057;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #4facfe;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .search-input-group {
                flex-direction: column;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .stats-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” èŠå¤©è®°å½•æœç´¢</h1>
            <p>å®æ—¶æœç´¢æ‚¨çš„èŠå¤©è®°å½•ï¼Œæ”¯æŒå…³é”®è¯ã€å‘é€è€…ã€æ—¥æœŸç­›é€‰</p>
        </div>

        <div class="search-section">
            <div class="search-form">
                <div class="search-input-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯...">
                    <button id="searchBtn" class="search-btn" onclick="startSearch()">å¼€å§‹æœç´¢</button>
                    <button id="cancelBtn" class="search-btn cancel-btn hidden" onclick="cancelSearch()">å–æ¶ˆæœç´¢</button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="senderFilter">å‘é€è€…ç­›é€‰</label>
                        <select id="senderFilter">
                            <option value="">å…¨éƒ¨å‘é€è€…</option>
                            <option value="æ˜Ÿå¦‚é›¨">æ˜Ÿå¦‚é›¨</option>
                            <option value="ç”Ÿç”Ÿ">ç”Ÿç”Ÿ</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="mediaFilter">åª’ä½“ç±»å‹</label>
                        <select id="mediaFilter">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="text">çº¯æ–‡æœ¬</option>
                            <option value="image">å›¾ç‰‡</option>
                            <option value="emoji">è¡¨æƒ…</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="dateFrom">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="dateFrom">
                    </div>
                    
                    <div class="filter-group">
                        <label for="dateTo">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="dateTo">
                    </div>
                </div>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <div class="progress-title">æœç´¢è¿›åº¦</div>
                <div class="progress-stats" id="progressStats">0 / 0 ä¸ªæ–‡ä»¶</div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="current-file" id="currentFile">å‡†å¤‡å¼€å§‹æœç´¢...</div>
        </div>

        <div class="stats-section">
            <div class="stats-content">
                <div class="stat-item">
                    <span class="stat-label">æœç´¢å…³é”®è¯:</span>
                    <span class="stat-value" id="searchKeyword">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ‰¾åˆ°ç»“æœ:</span>
                    <span class="stat-value" id="resultCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœç´¢æ–‡ä»¶:</span>
                    <span class="stat-value" id="fileCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç”¨æ—¶:</span>
                    <span class="stat-value" id="searchTime">0ç§’</span>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-title">æœç´¢ç»“æœ</div>
                <div class="results-count" id="resultsCount" style="display: none;">0 æ¡ç»“æœ</div>
            </div>
            <div id="results">
                <div class="no-results">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢èŠå¤©è®°å½•</div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allFiles = [];
        let searchResults = [];
        let currentPage = 1;
        let resultsPerPage = 20;
        let searchController = null;
        let searchStartTime = 0;
        let searchedFiles = 0;
        let totalFiles = 0;

        // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
        function initializeFileList() {
            // å®Œæ•´çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆä»2022å¹´åˆ°2025å¹´ï¼‰
            allFiles = [
                { url: 'Data/chat_2022_09_24.html', date: '2022-09-24' },
                { url: 'Data/chat_2022_10_01.html', date: '2022-10-01' },
                { url: 'Data/chat_2022_10_02.html', date: '2022-10-02' },
                { url: 'Data/chat_2022_10_05.html', date: '2022-10-05' },
                { url: 'Data/chat_2022_10_06.html', date: '2022-10-06' },
                { url: 'Data/chat_2022_10_07.html', date: '2022-10-07' },
                { url: 'Data/chat_2022_10_09.html', date: '2022-10-09' },
                { url: 'Data/chat_2022_10_10.html', date: '2022-10-10' },
                { url: 'Data/chat_2022_10_11.html', date: '2022-10-11' },
                { url: 'Data/chat_2022_10_14.html', date: '2022-10-14' },
                { url: 'Data/chat_2022_10_15.html', date: '2022-10-15' },
                { url: 'Data/chat_2022_10_16.html', date: '2022-10-16' },
                { url: 'Data/chat_2022_10_20.html', date: '2022-10-20' },
                { url: 'Data/chat_2022_10_21.html', date: '2022-10-21' },
                { url: 'Data/chat_2022_10_22.html', date: '2022-10-22' },
                { url: 'Data/chat_2022_10_23.html', date: '2022-10-23' },
                { url: 'Data/chat_2022_10_26.html', date: '2022-10-26' },
                { url: 'Data/chat_2022_10_28.html', date: '2022-10-28' },
                { url: 'Data/chat_2022_10_29.html', date: '2022-10-29' },
                { url: 'Data/chat_2022_10_30.html', date: '2022-10-30' },
                { url: 'Data/chat_2022_10_31.html', date: '2022-10-31' },
                { url: 'Data/chat_2022_11_01.html', date: '2022-11-01' },
                { url: 'Data/chat_2022_11_02.html', date: '2022-11-02' },
                { url: 'Data/chat_2022_11_03.html', date: '2022-11-03' },
                { url: 'Data/chat_2022_11_04.html', date: '2022-11-04' },
                { url: 'Data/chat_2022_11_05.html', date: '2022-11-05' },
                { url: 'Data/chat_2022_11_06.html', date: '2022-11-06' },
                { url: 'Data/chat_2022_11_07.html', date: '2022-11-07' },
                { url: 'Data/chat_2022_11_09.html', date: '2022-11-09' },
                { url: 'Data/chat_2022_11_10.html', date: '2022-11-10' },
                { url: 'Data/chat_2022_11_11.html', date: '2022-11-11' },
                { url: 'Data/chat_2022_11_12.html', date: '2022-11-12' },
                { url: 'Data/chat_2022_11_13.html', date: '2022-11-13' },
                { url: 'Data/chat_2022_11_14.html', date: '2022-11-14' },
                { url: 'Data/chat_2022_11_15.html', date: '2022-11-15' },
                { url: 'Data/chat_2022_11_16.html', date: '2022-11-16' },
                { url: 'Data/chat_2022_11_17.html', date: '2022-11-17' },
                { url: 'Data/chat_2022_11_18.html', date: '2022-11-18' },
                { url: 'Data/chat_2022_11_19.html', date: '2022-11-19' },
                { url: 'Data/chat_2022_11_20.html', date: '2022-11-20' },
                { url: 'Data/chat_2022_11_21.html', date: '2022-11-21' },
                { url: 'Data/chat_2022_11_22.html', date: '2022-11-22' },
                { url: 'Data/chat_2022_11_23.html', date: '2022-11-23' },
                { url: 'Data/chat_2022_11_24.html', date: '2022-11-24' },
                { url: 'Data/chat_2022_11_25.html', date: '2022-11-25' },
                { url: 'Data/chat_2022_11_26.html', date: '2022-11-26' },
                { url: 'Data/chat_2022_11_27.html', date: '2022-11-27' },
                { url: 'Data/chat_2022_11_28.html', date: '2022-11-28' },
                { url: 'Data/chat_2022_11_29.html', date: '2022-11-29' },
                { url: 'Data/chat_2022_11_30.html', date: '2022-11-30' },
                { url: 'Data/chat_2022_12_02.html', date: '2022-12-02' },
                { url: 'Data/chat_2022_12_03.html', date: '2022-12-03' },
                { url: 'Data/chat_2022_12_10.html', date: '2022-12-10' },
                { url: 'Data/chat_2022_12_12.html', date: '2022-12-12' },
                { url: 'Data/chat_2022_12_20.html', date: '2022-12-20' },
                { url: 'Data/chat_2022_12_28.html', date: '2022-12-28' },
                { url: 'Data/chat_2022_12_29.html', date: '2022-12-29' },
                { url: 'Data/chat_2022_12_30.html', date: '2022-12-30' },
                { url: 'Data/chat_2022_12_31.html', date: '2022-12-31' },
                { url: 'Data/chat_2023_01_01.html', date: '2023-01-01' },
                { url: 'Data/chat_2023_01_02.html', date: '2023-01-02' },
                { url: 'Data/chat_2023_01_03.html', date: '2023-01-03' },
                { url: 'Data/chat_2023_01_04.html', date: '2023-01-04' },
                { url: 'Data/chat_2023_01_05.html', date: '2023-01-05' },
                { url: 'Data/chat_2023_01_06.html', date: '2023-01-06' },
                { url: 'Data/chat_2023_01_07.html', date: '2023-01-07' },
                { url: 'Data/chat_2023_01_08.html', date: '2023-01-08' },
                { url: 'Data/chat_2023_01_09.html', date: '2023-01-09' },
                { url: 'Data/chat_2023_01_10.html', date: '2023-01-10' },
                { url: 'Data/chat_2023_01_11.html', date: '2023-01-11' },
                { url: 'Data/chat_2023_01_12.html', date: '2023-01-12' },
                { url: 'Data/chat_2023_01_13.html', date: '2023-01-13' },
                { url: 'Data/chat_2023_01_14.html', date: '2023-01-14' },
                { url: 'Data/chat_2025_09_28.html', date: '2025-09-28' }
            ];
        }

        // å¼€å§‹æœç´¢
        async function startSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            // é‡ç½®çŠ¶æ€
            searchResults = [];
            currentPage = 1;
            searchedFiles = 0;
            searchStartTime = Date.now();
            
            // æ›´æ–°UI
            document.getElementById('searchBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('results').innerHTML = '';
            document.getElementById('pagination').innerHTML = '';
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // è¿‡æ»¤æ–‡ä»¶
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let filesToSearch = allFiles.filter(file => {
                if (dateFrom && file.date < dateFrom) return false;
                if (dateTo && file.date > dateTo) return false;
                return true;
            });
            
            totalFiles = filesToSearch.length;
            updateProgress();
            
            // åˆ›å»ºæœç´¢æ§åˆ¶å™¨
            searchController = new AbortController();
            
            try {
                // é€ä¸ªæœç´¢æ–‡ä»¶ï¼Œå®æ—¶æ›´æ–°è¿›åº¦
                for (let i = 0; i < filesToSearch.length; i++) {
                    if (searchController.signal.aborted) {
                        break;
                    }
                    
                    const file = filesToSearch[i];
                    const results = await searchSingleFile(file, searchTerm, searchController.signal);
                    
                    // ç«‹å³æ·»åŠ æ–°ç»“æœ
                    if (results.length > 0) {
                        searchResults.push(...results);
                        searchResults.sort((a, b) => {
                            const timeA = new Date(a.date + ' ' + a.time);
                            const timeB = new Date(b.date + ' ' + b.time);
                            return timeB - timeA;
                        });
                        displayResults();
                    }
                    
                    searchedFiles++;
                    updateProgress();
                    updateStats();
                }
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Search error:', error);
                    document.getElementById('results').innerHTML = '<div class="no-results">æœç´¢å‡ºé”™ï¼Œè¯·é‡è¯•</div>';
                }
            } finally {
                finishSearch();
            }
        }

        // æœç´¢å•ä¸ªæ–‡ä»¶
        async function searchSingleFile(file, searchTerm, signal) {
            try {
                // æ›´æ–°å½“å‰æ–‡ä»¶æ˜¾ç¤º
                document.getElementById('currentFile').textContent = `æ­£åœ¨æœç´¢: ${file.url}`;
                
                const response = await fetch(file.url, { signal });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const messages = [];
                const messageElements = doc.querySelectorAll('.message');
                
                messageElements.forEach(message => {
                    if (signal.aborted) return;
                    
                    try {
                        const senderElement = message.querySelector('.message-header .sender');
                        const contentElement = message.querySelector('.message-content');
                        const timeElement = message.querySelector('.message-header .time');

                        if (senderElement && contentElement) {
                            const sender = senderElement.textContent.trim();
                            let content = contentElement.textContent.trim();
                            
                            // è·å–æ‰€æœ‰æ–‡æœ¬å†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡altæ–‡æœ¬
                            const textParts = [];
                            let mediaType = 'text';
                            let hasImage = false;
                            let hasEmoji = false;
                            
                            contentElement.querySelectorAll('*').forEach(el => {
                                if (el.nodeType === Node.TEXT_NODE) {
                                    textParts.push(el.textContent);
                                } else if (el.tagName === 'IMG') {
                                    const alt = el.getAttribute('alt') || '';
                                    const src = el.getAttribute('src') || '';
                                    if (alt) textParts.push(alt);
                                    hasImage = true;
                                    if (alt && alt.startsWith('/')) {
                                        hasEmoji = true;
                                    }
                                    mediaType = hasEmoji ? 'emoji' : 'image';
                                } else if (el.tagName === 'VIDEO') {
                                    mediaType = 'video';
                                } else if (el.tagName === 'AUDIO') {
                                    mediaType = 'audio';
                                } else if (el.classList && el.classList.contains('sticker')) {
                                    mediaType = 'sticker';
                                } else {
                                    textParts.push(el.textContent);
                                }
                            });
                            
                            content = textParts.join(' ').trim();
                            
                            // å¦‚æœå†…å®¹ä¸ºç©ºä½†æœ‰åª’ä½“å…ƒç´ ï¼Œä½¿ç”¨åª’ä½“ç±»å‹ä½œä¸ºå†…å®¹
                            if (!content && mediaType !== 'text') {
                                content = `[${mediaType}]`;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«æœç´¢å…³é”®è¯
                            if (content.toLowerCase().includes(searchTerm.toLowerCase())) {
                                messages.push({
                                    sender: sender,
                                    content: content,
                                    time: timeElement ? timeElement.textContent.trim() : '',
                                    fileUrl: file.url,
                                    date: file.date,
                                    hasImage: hasImage,
                                    hasEmoji: hasEmoji,
                                    mediaType: mediaType
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing message:', e);
                    }
                });
                
                return filterMessages(messages);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.warn('Error searching file:', file.url, error);
                }
                return [];
            }
        }

        // è¿‡æ»¤æ¶ˆæ¯
        function filterMessages(messages) {
            const senderFilter = document.getElementById('senderFilter').value;
            const mediaFilter = document.getElementById('mediaFilter').value;
            
            return messages.filter(message => {
                // å‘é€è€…è¿‡æ»¤
                if (senderFilter && message.sender !== senderFilter) {
                    return false;
                }
                
                // åª’ä½“ç±»å‹è¿‡æ»¤
                if (mediaFilter && message.mediaType !== mediaFilter) {
                    return false;
                }
                
                return true;
            });
        }

        // å–æ¶ˆæœç´¢
        function cancelSearch() {
            if (searchController) {
                searchController.abort();
            }
            finishSearch();
        }

        // å®Œæˆæœç´¢
        function finishSearch() {
            document.getElementById('searchBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('active');
            
            const searchTime = ((Date.now() - searchStartTime) / 1000).toFixed(1);
            document.getElementById('searchTime').textContent = `${searchTime}ç§’`;
            
            if (searchResults.length === 0) {
                document.getElementById('results').innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„èŠå¤©è®°å½•</div>';
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = totalFiles > 0 ? (searchedFiles / totalFiles * 100) : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressStats').textContent = `${searchedFiles} / ${totalFiles} ä¸ªæ–‡ä»¶`;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            document.getElementById('searchKeyword').textContent = searchTerm || '-';
            document.getElementById('resultCount').textContent = searchResults.length;
            document.getElementById('fileCount').textContent = searchedFiles;
            
            const resultsCount = document.getElementById('resultsCount');
            if (searchResults.length > 0) {
                resultsCount.textContent = `${searchResults.length} æ¡ç»“æœ`;
                resultsCount.style.display = 'block';
            } else {
                resultsCount.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults() {
            const resultsContainer = document.getElementById('results');
            
            if (searchResults.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„èŠå¤©è®°å½•</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // åˆ†é¡µ
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const pageResults = searchResults.slice(startIndex, endIndex);

            // ç”Ÿæˆç»“æœHTML
            let html = '';
            pageResults.forEach(result => {
                const highlightedContent = highlightSearchTerm(result.content, document.getElementById('searchInput').value);
                html += `
                    <div class="result-item" onclick="openChatFile('${result.fileUrl}', '${result.time}')">
                        <div class="result-date">${result.date} ${result.time}</div>
                        <div class="result-sender">${result.sender}</div>
                        <div class="result-content">${highlightedContent}</div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
            
            // ç”Ÿæˆåˆ†é¡µ
            createPagination();
        }

        // é«˜äº®æœç´¢å…³é”®è¯
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // åˆ›å»ºåˆ†é¡µæ§ä»¶
        function createPagination() {
            const totalPages = Math.ceil(searchResults.length / resultsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '';
            
            // ä¸Šä¸€é¡µ
            if (currentPage > 1) {
                html += `<button onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="active">${i}</button>`;
                } else {
                    html += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages) {
                html += `<button onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationContainer.innerHTML = html;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            currentPage = page;
            displayResults();
        }

        // æ‰“å¼€èŠå¤©æ–‡ä»¶
        function openChatFile(fileUrl, time) {
            window.open(fileUrl + '#time=' + encodeURIComponent(time), '_blank');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å›è½¦é”®æœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startSearch();
                }
            });

            // ç­›é€‰æ¡ä»¶å˜åŒ–æ—¶é‡æ–°æœç´¢
            ['senderFilter', 'mediaFilter', 'dateFrom', 'dateTo'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (document.getElementById('searchInput').value.trim()) {
                        startSearch();
                    }
                });
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileList();
            setupEventListeners();
        });
    </script>
</body>
</html>